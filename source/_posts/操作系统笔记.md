---
title: 操作系统笔记
tags:
  - operator system
categories:
  - four fundamental computer technology
abbrlink: 8ce3e425
date: 2022-04-23 11:42:57
---

{% label primary@声明：%}
以下笔记内容摘自现代操作系统原理与实现.陈海波、夏虞斌 等著

<!-- more -->

## **操作系统概述**
---
操作系统有两个职责：对**硬件**进行管理和抽象，为**应用**提供服务并进行管理

![操作系统简要结构](/images/操作系统的简要结构.svg)

操作系统简史
- GM-NAA I/O: 第一个(批处理)操作系统
- OS/360: 从专用走向通用
- Multics/UNIX/Linux: 分时与多任务
- macOS/Windows: 以人为本的人机交互

操作系统接口
从应用角度，操作系统提供了不同层次的接口，主要包括：
- 系统调用接口
- POSIX接口
- 领域应用接口

![不同层次的操作系统接口](/images/不同层次操作系统接口.svg)

ChCore用于本书教学而开发的实验操作系统，基本结构如下所示：

![ChCore系统架构示意图](/images/ChCore系统架构示意图.svg)

## **硬件结构**
---
冯·诺伊曼结构包括三个主要部分：
- 中央处理单元
- 存储器
- 输入输出

![冯诺依曼结构示意图](/images/冯诺依曼结构示意图.svg)

ISA- Instruction Set Architecture - 指令集架构
- RISC(Reduced Instruction Set Computer)- 精简指令集计算机
- CISC(Complex Instruction Set Computer)- 复杂指令集计算机

RISC - AArch64
每条指令的长度固定4字节，指令类型包括：
- 数据搬移指令(mov)
- 寄存器计算指令(add/sub)
- 内存读写指令(ldr/str)
- 跳转指令(b)
- 过程调用指令(bl/ret)
- 特权指令(mrs/msr)

## **操作系统结构**
---
在构建复杂系统时，必须合理考虑其内部结构，在不同的需求之间进行**权衡**。

操作系统乃至计算机系统中控制复杂度的一个重要设计原则是：将**策略**与**机制**相分离。
策略表示“做什么”，机制表示“如何做”

<center><font color=#F78A52>典型的操作系统机制与策略</font></center>

||策略|机制|
|:---:|:---:|:---:|
|登录|什么用户、以什么权限登录等|输入处理、策略文件管理、桌面启动加载等|
|调度|先到先得、时间片轮转等|调度队列的设计、调度实体的表示、调度的中断处理等|

管理复杂系统的重要方法是M.A.L.H方法，即
- 模块化(modularity)
- 抽象(abstraction)
- 分层(layering)
  - 不同类模块之间的层级
- 层级(hierarchy)
  - 同类模块之间的分层

操作系统内核架构：
- 简要结构
- 宏内核
- 微内核
- 外核
- 多核 & 混合内核

**简要结构**
一些功能较为简单的操作系统，会选择将应用程序与操作系统放置在同一个地址空间中，无需底层硬件提供复杂的内存管理、特权级隔离等功能。

典型示例：MS-DOS(MicrSoft Disk Operating System)
优点：应用程序对操作系统服务的调用无需切换地址空间和权限层级，因此更加高效。
缺点：任何一个应用或操作系统模块出现了问题，均有可能使整个系统崩溃。

![MS-DOS的系统结构](/images/MS-DOS的系统结构.svg)

**宏内核架构**
又称**单内核**，其特征是操作系统内核的所有模块(包括进程调度、内存管理、文件系统、设备驱动等)均运行在内核态，具备直接操作硬件的能力，这类操作系统包裹UNIX/Linux、FreeBSD等。

![宏内核的基本结构](/images/宏内核的基本结构.svg)

**微内核**
将单个功能或模块(如文件系统、设备驱动等)从内核中拆分出来，作为一个独立的服务部署到独立的运行环境中；内核仅保留极少的功能，为这些服务提供通信等基础能力，使其能够互相协作以完成操作系统所必需的功能。

**外核架构**
外核架构可以为不同应用提供定制化的高效资源管理：按照不同应用领域的要求，将对硬件资源的抽象模块化为一系列的库(即**LibOS**).


操作系统框架结构：
- Android 系统框架
- ROS 系统框架

**Android 系统框架**
在Linux内核之上运行的Android系统框架包括如下几个主要组件：
1. 硬件抽象层
2. Android库
3. Android运行环境
4. Android应用框架
5. 服务化架构与BinderIPC

![Android操作系统架构](/images/Android操作系统架构.svg)


## **内存管理**
---
Q:操作系统如何让不同的应用程序能够即***高效*** 又 ***安全***地共同使用物理内存资源呢？
A:在应用程序与物理内存之间加入一个新的抽象：<font color=#F78A52>虚拟内存</font>

虚拟内存的设计三目标：
- 高效性
  - 不能在应用程运行的过程中造成明显的性能开销
  - 不应该占用过多的物理内存资源，明显降低物理内存的有效利用率
- 安全性
  - 虚拟内存抽象需要使不同应用程序的内存互相隔离
- 透明性
  - 应用开发者在编程时无须考虑虚拟内存抽象

**虚拟地址 & 物理地址**

![CPU地址翻译示意图](/images/CPU地址翻译示意图.svg)

MMU - Memory Management Unit -- 内存管理单元，负责虚拟地址到物理地址的转换

TLB - Translation Lookaside Buffer -- 转址旁路缓存，加速地址翻译的过程

MMU将虚拟地址翻译为物理地址的主要机制有两种：
- 分段机制
  - 操作系统能够实现物理内存资源的离散分配，易造成外部碎片
- 分页机制
  - 被现代操作系统广泛采用

![分段机制下地址翻译规则示意图](/images/分段机制下地址翻译规则示意图.svg)

**基于分页的虚拟内存**
AArch64架构下的4级页表

![AArch64体系结构下基于4级页表的地址翻译](/images/AArch64体系结构下基于4级页表的地址翻译.svg)

一个64位的虚拟地址在逻辑上被划分成如下几个部分：
- 第63位至48位：全为0或者全为1（硬件要求）
- 第47位至39位：这9位作为该虚拟地址在第0级页表中的索引值，对应图中的虚拟页号0
- 第38位至30位：这9位作为该虚拟地址在第1级页表中的索引值，对应图中的虚拟页号1
- 第29位至21位：这9位作为该虚拟地址在第2级页表中的索引值，对应图中的虚拟页号2
- 第20位至12位：这9位作为该虚拟地址在第3级页表中的索引值，对应图中的虚拟页号3
- 第11位至0位：由于页的大小是4KB，所以低12位代表页内偏移量

TLB：加速地址翻译

![TLB的结构示意图](/images/TLB的结构示意图.svg)

TLB刷新? 切换应用主动刷新TLB
避免刷新带来的开销：
- AArch64体系，采用ASID(Address Space IDentifier)
- x86-64, 采用PCID(Process Context IDentifier)

缺页 & 换页异常

页替换策略
- MIN策略/OPT策略
- FIFO策略
- Second Chance策略
- LRU策略
- MRU策略
- 时钟算法策略

工作集模型：能够有效地避免颠簸现象的发生

**虚拟内存功能**

- 共享内存
  - 让不同应用程序之间互相通信/传递数据
- 写时拷贝
  - 能够节约物理内存资源，比如不同的应用程序以写时拷贝的方式映射相同的动态链接库
  - 让父子程序以只读方式共享全部内存数据，避免内存拷贝操作带来的时间和空间开销
- 内存去重
- 内存压缩
- 大页
  - 减少TLB缓存项的消耗，从而有机会提高TLB命中率
  - 减少页表级数，从而提升查询页表的效率
  - 应用程序可能未使用整个大页而造成物理内存资源浪费
  - 增加操作系统管理内存的复杂度

**物理内存分配与管理**
1. 物理内存分配器设计的连个重要评价维度：
   - 内存资源利用率
     - 内存碎片 -- 无法被利用的内存，其直接导致内存资源利用率的下降
       - 内部碎片
       - 外部碎片
   - 性能
     - 尽可能降低分配延迟和节约CPU资源
2. 伙伴系统 - buddy system
   - 在现代操作系统中被广泛地用于分配连续的物理内存页
   - 将物理内存划分成连续的块，以块作为基本单位进行分配
  ![伙伴块的分裂与合并](/images/伙伴块的分裂与合并.svg)
3. SLAB分配器
   - 用于分配几十个或几百个字节的小内存
   - SLAB/SLUB/SLOB 统称 SLAB分配器
4. 常用的空闲链表
   - 隐式空闲链表
   - 显示空闲链表
   - 分离空闲链表
5. 物理内存与CPU缓存
   - 软件方案：染色机制
   - 硬件方案：Intel CAT
   - 硬件方案：ARMv8-A MPAM(Memory System Resource Partitioning and Monitoring)

**ChCore内存管理机制**
实验内核ChCore，内存管理部分三个重要数据结构：
- 虚拟地址空间struct vmspace
- 虚拟地址区域struct vmregion
- 物理内存对象struct pmobject
